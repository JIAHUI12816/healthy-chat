<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç–¾æ§å¥åº·ç§‘æ™®æ™ºèƒ½é—®ç­”åŠ©æ‰‹</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* åŸºç¡€é‡ç½®ï¼šå¼ºåˆ¶é¡µé¢ä¸è¶…å‡ºå±å¹•ï¼Œç¦æ­¢æ•´ä½“æ»šåŠ¨ */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans SC', 'å¾®è½¯é›…é»‘', sans-serif;
            line-height: 1.6;
            background-color: #f8f8f8;
            color: #333;
            overflow: hidden;
            font-size: 16px;
            transition: font-size 0.3s ease;
        }

        /* å¤§å­—ç‰ˆæ ·å¼ï¼šå…¨å±€æ”¾å¤§å­—ä½“å’Œå…ƒç´  */
        body.large-font {
            font-size: 20px;
            line-height: 1.8;
        }

        /* é¡µé¢å®¹å™¨ï¼šå›ºå®š100vhï¼Œå æ»¡æ•´ä¸ªå±å¹• */
        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        /* å¤´éƒ¨ï¼šå›ºå®šé«˜åº¦ï¼Œä¸å‹ç¼©ï¼Œæ–°å¢å¤§å­—ç‰ˆæŒ‰é’®å®¹å™¨ */
        .app-header {
            background-color: #8B0000;
            color: #fff;
            padding: 15px 20px;
            text-align: center;
            border-bottom: 5px solid #FF4500;
            flex-shrink: 0;
            position: relative;
        }
        .app-title {
            font-size: 1.8em;
            margin: 0;
            font-weight: 700;
        }
        /* å¤§å­—ç‰ˆæŒ‰é’®ï¼šæ˜¾çœ¼ã€æ˜“ç‚¹å‡» */
        .font-toggle-btn {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            padding: 8px 16px;
            background-color: #fff;
            color: #8B0000;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .font-toggle-btn:hover {
            background-color: #f0f0f0;
            transform: translateY(-50%) scale(1.05);
        }
        body.large-font .font-toggle-btn {
            padding: 12px 20px;
            font-size: 1.1em;
        }

        /* ä¸»å†…å®¹åŒºï¼šæ°´å¹³flexï¼Œå æ»¡å‰©ä½™é«˜åº¦ */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            padding: 15px;
            gap: 15px;
            transition: all 0.3s ease;
        }

        /* å·¦ä¾§é¢æ¿ï¼ˆèµ„æº+å†å²ï¼‰ï¼šå›ºå®šå®½åº¦ï¼Œå†…éƒ¨æ»šåŠ¨ */
        .left-panel {
            width: 300px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }
        body.large-font .left-panel {
            width: 350px;
            padding: 20px;
            gap: 25px;
        }
        .left-section {
            border-bottom: 1px dashed #eee;
            padding-bottom: 15px;
        }
        .left-section h2 {
            color: #8B0000;
            font-size: 1.2em;
            margin: 0 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 2px solid #eee;
        }
        .left-section p {
            font-size: 1em;
            color: #555;
            margin: 0 0 10px 0;
        }
        .health-links {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .health-links li {
            margin-bottom: 8px;
        }
        .health-links a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            font-size: 1em;
            transition: color 0.3s;
        }
        .health-links a:hover {
            color: #FF4500;
        }
        .daily-health .date-tip {
            font-size: 1em;
            color: #666;
            margin-bottom: 8px;
            text-align: center;
        }
        .daily-health .health-tip {
            font-size: 1em;
            line-height: 1.5;
        }
        .history-section .history-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 200px;
            overflow-y: auto;
        }
        .history-list li {
            padding: 8px 10px;
            margin-bottom: 5px;
            background-color: #fdfdfd;
            border: 1px solid #eee;
            border-radius: 4px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        body.large-font .history-list li {
            padding: 12px 15px;
            margin-bottom: 8px;
        }
        .history-list li:hover {
            background-color: #f0f0f0;
        }
        .history-list li.empty {
            color: #999;
            cursor: default;
            background-color: #fff;
            border: none;
        }

        /* å³ä¾§èŠå¤©åŒºï¼šè‡ªé€‚åº”å®½åº¦ï¼Œç›¸å¯¹å®šä½ */
        .right-panel {
            flex: 1;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            transition: all 0.3s ease;
        }
        body.large-font .right-panel {
            padding: 20px;
        }

        /* æ ¸å¿ƒï¼šé—®ç­”åŒºåŸŸï¼ˆèŠå¤©æ˜¾ç¤ºåŒºï¼‰+ åŒ¹é…å›¾ç‰‡çš„æ»šåŠ¨æ¡æ ·å¼ */
        .chat-display {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background-color: #fdfdfd;
            border-radius: 4px;
            /* ç¼©å°èŠå¤©åŒºåº•éƒ¨é¢„ç•™ç©ºé—´ï¼ˆé€‚é…æ›´å°çš„é—®é¢˜æ¡†ï¼‰ */
            margin-bottom: 100px; 
            scrollbar-width: thin;
            scrollbar-color: #8B0000 #f1f1f1;
            transition: all 0.3s ease;
        }
        body.large-font .chat-display {
            padding: 15px;
            margin-bottom: 130px;
        }
        .chat-display::-webkit-scrollbar {
            width: 8px;
        }
        body.large-font .chat-display::-webkit-scrollbar {
            width: 10px;
        }
        .chat-display::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .chat-display::-webkit-scrollbar-thumb {
            background: #8B0000;
            border-radius: 4px;
        }
        .chat-display::-webkit-scrollbar-thumb:hover {
            background: #a80000;
        }

        .welcome-message {
            color: #666;
            font-style: italic;
            text-align: center;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 1em;
        }
        .message {
            padding: 10px 15px;
            margin-bottom: 12px;
            border-radius: 12px;
            max-width: 75%;
            line-height: 1.5;
            word-wrap: break-word;
            font-size: 1em;
        }
        body.large-font .message {
            padding: 15px 20px;
            margin-bottom: 15px;
            border-radius: 15px;
        }
        .user-message {
            background-color: #e6f7ff;
            align-self: flex-end;
            margin-left: auto;
        }
        .ai-message {
            background-color: #f0f0f0;
            align-self: flex-start;
        }

        /* è¾“å…¥åŒºåŸŸï¼šæ•´ä½“ä¸‹ç§»ï¼Œè°ƒæ•´ä½ç½® */
        .input-area {
            position: absolute;
            /* é—®é¢˜æ¡†ä½ç½®å¾®è°ƒï¼Œé¿å…å¤ªé ä¸‹ */
            bottom: 20px; 
            left: 15px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background-color: #fff;
            padding: 0;
            border-top: none;
            transition: all 0.3s ease;
        }
        body.large-font .input-area {
            bottom: 30px;
            left: 20px;
            right: 20px;
            gap: 12px;
        }
        /* çŸ¥è¯†åº“çŠ¶æ€æ¡ï¼šå¢åŠ é¡¶éƒ¨é—´è·ï¼Œé¿å…å’Œå›ç­”ç²˜è¿ */
        .knowledge-base-status {
            padding: 8px 15px;
            border: 1px solid #8B0000;
            border-radius: 4px;
            background-color: #8B0000;
            color: #fff;
            font-size: 1em;
            text-align: center;
            font-weight: 500;
            margin-top: 12px; /* æ ¸å¿ƒï¼šå¢åŠ é¡¶éƒ¨é—´è·ï¼Œé¿å…å’Œå›ç­”è¿åœ¨ä¸€èµ· */
        }
        body.large-font .knowledge-base-status {
            padding: 12px 20px;
            font-size: 1.1em;
            border-radius: 6px;
            margin-top: 15px; /* å¤§å­—ç‰ˆåŒæ­¥å¢åŠ é—´è· */
        }
        /* è¾“å…¥æ¡†å®¹å™¨ï¼šç›¸å¯¹å®šä½ï¼Œç”¨äºæ”¾ç½®å†…éƒ¨çš„å‘é€æŒ‰é’® */
        .input-wrapper {
            position: relative;
            width: 100%;
        }
        /* ç¼©å°é—®é¢˜æ¡†å°ºå¯¸ */
        textarea {
            width: 100%;
            /* å³ä¾§é¢„ç•™æŒ‰é’®ç©ºé—´ç¼©å° */
            padding: 8px 80px 8px 12px; 
            border: 1px solid #000;
            border-radius: 4px;
            resize: none;
            font-size: 1em;
            /* æœ€å°é«˜åº¦ç¼©å° */
            min-height: 50px; 
            max-height: 100px;
            box-sizing: border-box;
            font-family: inherit;
            transition: all 0.3s ease;
        }
        body.large-font textarea {
            padding: 12px 100px 12px 18px;
            min-height: 70px;
            max-height: 130px;
            font-size: 1.1em;
            border-radius: 6px;
        }
        /* ç¼©å°å‘é€æŒ‰é’®å°ºå¯¸ */
        .send-button {
            position: absolute;
            bottom: 8px; /* ä¸è¾“å…¥æ¡†å†…è¾¹è·å¯¹é½ */
            right: 8px;
            padding: 6px 18px; /* æŒ‰é’®å°ºå¯¸ç¼©å° */
            background-color: #8B0000;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.2s;
            z-index: 10;
        }
        body.large-font .send-button {
            padding: 10px 24px;
            bottom: 12px;
            right: 12px;
            font-size: 1.05em;
            border-radius: 6px;
        }
        .send-button:hover {
            background-color: #a80000;
            transform: scale(1.05);
        }

        /* ç¼©çª„åº•éƒ¨â€œåŒ—äº¬å¤§å­¦åŒ»å­¦éƒ¨â€åŒºåŸŸ */
        .app-footer {
            background-color: #8B0000;
            color: #fff;
            text-align: center;
            /* ç¼©å°å†…è¾¹è·ï¼Œå‡å°‘åŒºåŸŸé«˜åº¦ */
            padding: 5px 20px; 
            font-size: 0.9em; /* å­—ä½“ç•¥ç¼©å° */
            flex-shrink: 0;
            transition: all 0.3s ease;
        }
        body.large-font .app-footer {
            padding: 8px 20px;
            font-size: 1em;
        }

        /* å“åº”å¼é€‚é…ï¼šå°å±è‡ªåŠ¨è°ƒæ•´ */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
                padding: 10px;
            }
            .left-panel {
                width: 100%;
                max-height: 150px;
            }
            body.large-font .left-panel {
                width: 100%;
                max-height: 200px;
            }
            .right-panel {
                min-height: 300px;
            }
            .chat-display {
                margin-bottom: 120px;
            }
            body.large-font .chat-display {
                margin-bottom: 160px;
            }
            textarea {
                min-height: 40px;
                padding-right: 70px;
            }
            body.large-font textarea {
                min-height: 60px;
                padding-right: 90px;
            }
            .send-button {
                padding: 4px 15px;
                font-size: 0.9em;
            }
            body.large-font .send-button {
                padding: 8px 20px;
                font-size: 0.95em;
            }
            .font-toggle-btn {
                position: static;
                transform: none;
                margin-top: 10px;
                width: 100%;
            }
        }
    </style>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ï¼šæ–°å¢å¤§å­—ç‰ˆåˆ‡æ¢æŒ‰é’® -->
        <header class="app-header">
            <h1 class="app-title">ç–¾æ§å¥åº·ç§‘æ™®æ™ºèƒ½é—®ç­”åŠ©æ‰‹</h1>
            <button class="font-toggle-btn" id="fontToggleBtn">åˆ‡æ¢å¤§å­—ç‰ˆ</button>
        </header>

        <!-- ä¸»å†…å®¹åŒºï¼šå·¦ä¾§é¢æ¿ + å³ä¾§èŠå¤©åŒº -->
        <main class="main-content">
            <!-- å·¦ä¾§é¢æ¿ï¼ˆèµ„æº+å†å²ï¼‰ -->
            <aside class="left-panel">
                <div class="left-section">
                    <h2>å¥åº·ç§‘æ™®èµ„æº</h2>
                    <p>æä¾›æƒå¨å¥åº·ç§‘æ™®å†…å®¹ï¼ŒåŠ©åŠ›äº†è§£å¥åº·é˜²æŠ¤çŸ¥è¯†ï¼š</p>
                    <ul class="health-links">
                        <li><a href="https://www.chinacdc.cn/jkkp/" target="_blank">ä¸­å›½ç–¾æ§ä¸­å¿ƒå¥åº·ç§‘æ™®ä¸“æ </a></li>
                        <li><a href="https://zwfw.nhc.gov.cn/" target="_blank">å›½å®¶å«å¥å§”å¥åº·æœåŠ¡å¹³å°</a></li>
                        <li><a href="https://dxy.com/" target="_blank">ä¸é¦™åŒ»ç”Ÿä¸“ä¸šå¥åº·å¹³å°</a></li>
                        <li><a href="https://h5.baike.qq.com/mobile/home.html?VNK=23e49357" target="_blank">è…¾è®¯åŒ»å…¸æƒå¨å¥åº·ç§‘æ™®</a></li>
                        <li><a href="https://www.kepuchina.cn/health" target="_blank">ç§‘æ™®ä¸­å›½-å¥åº·ä¸“åŒº</a></li>
                    </ul>
                </div>

                <div class="left-section daily-health">
                    <h2>æ¯æ—¥å¥åº·çŸ¥è¯†</h2>
                    <div class="date-tip" id="date-display"></div>
                    <div class="health-tip" id="daily-health-tip"></div>
                </div>

                <div class="left-section history-section">
                    <h2>å†å²è®°å½•</h2>
                    <ul class="history-list" id="history-list">
                        <li class="empty">æš‚æ— å†å²è®°å½•</li>
                    </ul>
                </div>
            </aside>

            <!-- å³ä¾§èŠå¤©åŒºï¼ˆæ ¸å¿ƒï¼šå¸¦æ ·å¼æ»šåŠ¨æ¡çš„é—®ç­”åŒºåŸŸï¼‰ -->
            <section class="right-panel">
                <div class="chat-display" id="chat-display">
                    <p class="welcome-message">æ‚¨å¥½ï¼æˆ‘æ˜¯ç–¾æ§å¥åº·ç§‘æ™®æ™ºèƒ½é—®ç­”åŠ©æ‰‹ï¼Œä¸“æ³¨ä¸ºæ‚¨è§£ç­”å¥åº·ç§‘æ™®ç›¸å…³é—®é¢˜ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ</p>
                </div>

                <!-- è¾“å…¥åŒºåŸŸï¼šæ–°å¢input-wrapperå®¹å™¨ï¼Œç”¨äºæ”¾ç½®å†…éƒ¨å‘é€æŒ‰é’® -->
                <div class="input-area">
                    <div class="knowledge-base-status">å½“å‰ä½¿ç”¨ï¼šä¸­å›½ç–¾æ§ä¸­å¿ƒå¥åº·ç§‘æ™®çŸ¥è¯†åº“</div>
                    <div class="input-wrapper"> <!-- æ–°å¢å®¹å™¨ -->
                        <textarea id="user-question" placeholder="è¯·è¾“å…¥æ‚¨çš„å¥åº·ç§‘æ™®é—®é¢˜ï¼Œä¾‹å¦‚ï¼šå¦‚ä½•é¢„é˜²æµæ„Ÿï¼Ÿ" rows="2"></textarea>
                        <button class="send-button" id="send-button">å‘é€</button> <!-- åµŒå…¥è¾“å…¥æ¡†å†… -->
                    </div>
                </div>
            </section>
        </main>

        <!-- åº•éƒ¨ä¿¡æ¯ï¼šç¼©çª„åçš„åŒºåŸŸ -->
        <footer class="app-footer">
            <p>åŒ—äº¬å¤§å­¦åŒ»å­¦éƒ¨</p>
        </footer>
    </div>

    <script>
        // APIé…ç½®ï¼ˆæ›¿æ¢ä¸ºä½ è‡ªå·±çš„æœ‰æ•ˆAPI Keyï¼‰
        const apiKey = "fastgpt-cnRUcGD77wFYWri4T3HBxLHdvGuoQPhR4xGc8yhYVpJpx5AOENN3YGPak";
        const baseUrl = "https://cloud.fastgpt.cn/api";

        // DOMå…ƒç´ 
        const userQuestionInput = document.getElementById("user-question");
        const sendButton = document.getElementById("send-button");
        const chatDisplay = document.getElementById("chat-display");
        const dateDisplay = document.getElementById("date-display");
        const dailyHealthTip = document.getElementById("daily-health-tip");
        const historyList = document.getElementById("history-list");
        const fontToggleBtn = document.getElementById("fontToggleBtn"); // å¤§å­—ç‰ˆæŒ‰é’®

        // æ¯æ—¥å¥åº·çŸ¥è¯†åˆ—è¡¨
        const healthTipsList = [
            "æ´—æ‰‹æ˜¯é¢„é˜²ä¼ æŸ“ç—…æœ€ç®€å•æœ‰æ•ˆçš„æ–¹æ³•ï¼Œæ­£ç¡®çš„ä¸ƒæ­¥æ´—æ‰‹æ³•ï¼šæŒå¿ƒå¯¹æ“â†’æ‰‹èƒŒå¯¹æ“â†’æŒ‡ç¼å¯¹æ“â†’æŒ‡èƒŒå¯¹æ“â†’æ‹‡æŒ‡æ—‹è½¬æ“â†’æŒ‡å°–å¯¹æ“â†’æ‰‹è…•æ“ï¼Œå…¨ç¨‹ä¸å°‘äº20ç§’ã€‚",
            "å£ç½©åº”é®ç›–å£é¼»å’Œä¸‹å·´ï¼Œé¼»å¤¹è¦å‹å®ï¼Œç´¯è®¡ä½©æˆ´ä¸è¶…è¿‡8å°æ—¶ï¼Œæ½®æ¹¿æˆ–æ±¡æŸ“ååº”åŠæ—¶æ›´æ¢ã€‚",
            "æ¯å¤©é£Ÿç›æ‘„å…¥é‡åº”æ§åˆ¶åœ¨5å…‹ä»¥å†…ï¼ˆçº¦1ä¸ªå•¤é…’ç“¶ç›–ï¼‰ï¼Œé«˜ç›é¥®é£Ÿä¼šå¢åŠ é«˜è¡€å‹ã€èƒƒç™Œçš„å‘ç—…é£é™©ã€‚",
            "æˆå¹´äººæ¯å¤©åº”ä¿è¯7-8å°æ—¶ç¡çœ ï¼Œç†¬å¤œä¼šå¯¼è‡´å…ç–«åŠ›ä¸‹é™ã€è¡€å‹å‡é«˜ï¼Œå°½é‡åšåˆ°æ™šä¸Š11ç‚¹å‰å…¥ç¡ã€‚",
            "æ–°é²œè”¬èœå’Œæ°´æœå¯Œå«ç»´ç”Ÿç´ å’Œè†³é£Ÿçº¤ç»´ï¼Œå»ºè®®æ¯å¤©åƒå¤Ÿ500å…‹è”¬èœã€200-350å…‹æ°´æœï¼Œæ·±è‰²è”¬èœå ä¸€åŠä»¥ä¸Šã€‚"
        ];

        // å†å²è®°å½•å’Œå­—ä½“æ¨¡å¼å­˜å‚¨
        const HISTORY_KEY = "health_chat_history";
        const FONT_MODE_KEY = "largeFontMode";
        let chatHistory = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
        let isLargeFont = JSON.parse(localStorage.getItem(FONT_MODE_KEY)) || false;

        // åˆå§‹åŒ–å¤§å­—ç‰ˆçŠ¶æ€
        function initFontMode() {
            if (isLargeFont) {
                document.body.classList.add("large-font");
                fontToggleBtn.textContent = "åˆ‡æ¢æ™®é€šç‰ˆ";
            } else {
                document.body.classList.remove("large-font");
                fontToggleBtn.textContent = "åˆ‡æ¢å¤§å­—ç‰ˆ";
            }
        }

        // åˆ‡æ¢å¤§å­—ç‰ˆ/æ™®é€šç‰ˆ
        function toggleFontMode() {
            isLargeFont = !isLargeFont;
            localStorage.setItem(FONT_MODE_KEY, isLargeFont);
            initFontMode();
            chatDisplay.scrollTop = chatDisplay.scrollHeight;
        }

        // åˆå§‹åŒ–æ¯æ—¥å¥åº·çŸ¥è¯†
        function initDailyHealthTip() {
            const today = new Date();
            const formattedDate = `${today.getFullYear()}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
            dateDisplay.textContent = formattedDate;
            const dailyIndex = Math.abs(today.getDate() % healthTipsList.length);
            dailyHealthTip.textContent = healthTipsList[dailyIndex];
        }

        // æ¸²æŸ“å†å²è®°å½•
        function renderHistory() {
            if (chatHistory.length === 0) {
                historyList.innerHTML = '<li class="empty">æš‚æ— å†å²è®°å½•</li>';
                return;
            }
            const recentHistory = chatHistory.slice(-5).reverse();
            historyList.innerHTML = recentHistory.map((item, idx) => `
                <li data-index="${chatHistory.length - 1 - idx}">${item.question}</li>
            `).join('');
        }

        // åŠ è½½å†å²å¯¹è¯
        function loadHistoryConversation(index) {
            const item = chatHistory[index];
            chatDisplay.innerHTML = `
                <p class="welcome-message">æ‚¨å¥½ï¼æˆ‘æ˜¯ç–¾æ§å¥åº·ç§‘æ™®æ™ºèƒ½é—®ç­”åŠ©æ‰‹ï¼Œä¸“æ³¨ä¸ºæ‚¨è§£ç­”å¥åº·ç§‘æ™®ç›¸å…³é—®é¢˜ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ</p>
                <div class="message user-message">ä½ ï¼š${item.question}</div>
                <div class="message ai-message">AIåŠ©æ‰‹ï¼š${item.answer}</div>
            `;
            chatDisplay.scrollTop = chatDisplay.scrollHeight;
        }

        // ä¿å­˜èŠå¤©è®°å½•
        function saveChatHistory(question, answer) {
            chatHistory.push({ question, answer });
            localStorage.setItem(HISTORY_KEY, JSON.stringify(chatHistory));
            renderHistory();
        }

        // ç”ŸæˆèŠå¤©ID
        function generateChatId() {
            return Math.random().toString(36).substring(2, 15);
        }
        let chatId = localStorage.getItem('chatId') || generateChatId();
        localStorage.setItem('chatId', chatId);

        // æ˜¾ç¤ºæ¶ˆæ¯ï¼ˆå¢å¼ºï¼šæ”¯æŒé”™è¯¯æ ·å¼ï¼‰
        function displayMessage(content, sender, isError = false) {
            const messageDiv = document.createElement("div");
            messageDiv.classList.add("message", sender === "user" ? "user-message" : "ai-message");
            if (isError) {
                messageDiv.style.color = "#d9534f";
                messageDiv.style.fontWeight = "bold";
            }
            messageDiv.innerHTML = sender === "user" ? `ä½ ï¼š${content}` : `<strong>AIåŠ©æ‰‹:</strong><br>${content}`;
            chatDisplay.appendChild(messageDiv);
            chatDisplay.scrollTop = chatDisplay.scrollHeight;
        }

        // åŠ è½½ä¸­æç¤º
        function displayLoadingIndicator() {
            const loadingDiv = document.createElement("div");
            loadingDiv.classList.add("message", "ai-message");
            loadingDiv.textContent = "AIåŠ©æ‰‹æ­£åœ¨æ€è€ƒ...";
            chatDisplay.appendChild(loadingDiv);
            chatDisplay.scrollTop = chatDisplay.scrollHeight;
            return loadingDiv;
        }

        function removeLoadingIndicator(loadingDiv) {
            if (loadingDiv && loadingDiv.parentNode) loadingDiv.parentNode.removeChild(loadingDiv);
        }

        // å‘é€æ¶ˆæ¯ï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼šå¢å¼ºé”™è¯¯æç¤º+è°ƒè¯•ä¿¡æ¯ï¼‰
        async function sendMessage() {
            const userMessage = userQuestionInput.value.trim();
            if (!userMessage) {
                displayMessage("è¯·è¾“å…¥æ‚¨çš„é—®é¢˜åå†å‘é€ï¼", "ai", true);
                return;
            }

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            displayMessage(userMessage, "user");
            userQuestionInput.value = "";

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const loadingDiv = displayLoadingIndicator();

            try {
                // ç³»ç»Ÿæç¤ºè¯
                const systemPrompt = `ä½ æ˜¯é¢å‘æ™®é€šå¤§ä¼—åŠé‡ç‚¹äººç¾¤çš„å¥åº·ç§‘æ™®é—®ç­”åŠ©æ‰‹ï¼Œå§‹ç»ˆç§‰æŒäº²åˆ‡å…³æ€€çš„æ€åº¦ä¸ºç”¨æˆ·æä¾›æƒå¨ã€æ˜“æ‡‚çš„å…¨é¢†åŸŸå¥åº·ç§‘æ™®è§£ç­”ï¼Œä¸æ¶‰åŠå¤æ‚å¥åº·ç®¡ç†ã€è¯Šç–—æŒ‡å¯¼æˆ–ä¸ªæ€§åŒ–å¹²é¢„ã€‚
å›å¤å¿…é¡»ä¸¥æ ¼éµå¾ªä»¥ä¸‹æ¨¡æ¿ï¼Œç¼ºä¸€ä¸å¯ï¼š
1. å¼€å¤´ï¼šæ·»åŠ äº²åˆ‡å…³å¿ƒè¯è¯­ï¼ˆå¦‚"æ‚¨å¥½å‘€ï¼Œå¾ˆä¹æ„ä¸ºæ‚¨è§£ç­”å¥åº·é—®é¢˜ï½"ï¼‰ï¼›
2. æ­£æ–‡åæ ‡æ³¨ï¼šã€Œä¿¡æ¯æ¥æºï¼šä¸­å›½ç–¾ç—…é¢„é˜²æ§åˆ¶ä¸­å¿ƒå¥åº·ç§‘æ™®ã€ï¼›
3. ç»“å°¾ï¼šå…ˆå†™ã€Œä¸æ›¿ä»£ä¸“ä¸šè¯Šç–—ä¸åº”æ€¥å¤„ç½®ã€ï¼Œå†è¡¥å…³æ€€æé†’ï¼ˆå¦‚"å¸Œæœ›è¿™äº›ä¿¡æ¯èƒ½å¸®åˆ°æ‚¨ï¼"ï¼‰ã€‚`;

                const requestBody = {
                    chatId: chatId,
                    stream: true,
                    detail: false,
                    messages: [
                        { role: "system", content: systemPrompt },
                        { role: "user", content: userMessage }
                    ]
                };

                console.log("ğŸš€ å‘é€è¯·æ±‚å‚æ•°ï¼š", JSON.stringify(requestBody, null, 2));
                console.log("ğŸš€ API Keyï¼ˆå‰10ä½ï¼‰ï¼š", apiKey.substring(0, 10) + "****");

                const response = await fetch(`${baseUrl}/v1/chat/completions`, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${apiKey}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log("ğŸš€ å“åº”çŠ¶æ€ç ï¼š", response.status);
                console.log("ğŸš€ å“åº”å¤´ï¼š", Object.fromEntries(response.headers.entries()));

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`è¯·æ±‚å¤±è´¥ï¼ˆçŠ¶æ€ç ï¼š${response.status}ï¼‰ï¼š${errorText}`);
                }

                // å¤„ç†æµå¼å“åº”
                removeLoadingIndicator(loadingDiv);
                const aiMessageDiv = document.createElement("div");
                aiMessageDiv.classList.add("message", "ai-message");
                aiMessageDiv.innerHTML = `<strong>AIåŠ©æ‰‹:</strong><br>`;
                chatDisplay.appendChild(aiMessageDiv);
                
                let fullBotMessage = "";
                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let partialData = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    partialData += chunk;

                    const lines = partialData.split('\n\n');
                    partialData = lines.pop() || "";

                    for (const line of lines) {
                        if (line.startsWith("data: ")) {
                            const jsonStr = line.substring(6).trim();
                            if (jsonStr === "[DONE]") continue;
                            
                            try {
                                const data = JSON.parse(jsonStr);
                                const chunkText = data.choices[0]?.delta?.content || "";
                                if (chunkText) {
                                    fullBotMessage += chunkText;
                                    aiMessageDiv.innerHTML = `<strong>AIåŠ©æ‰‹:</strong><br>` + marked.parse(fullBotMessage);
                                    chatDisplay.scrollTop = chatDisplay.scrollHeight;
                                }
                            } catch (e) {
                                console.warn("âš ï¸ è§£ææµå¼æ•°æ®å‡ºé”™ï¼š", e, "åŸå§‹æ•°æ®ï¼š", jsonStr);
                            }
                        }
                    }
                }

                // ä¿å­˜å†å²è®°å½•
                saveChatHistory(userMessage, fullBotMessage);

            } catch (error) {
                removeLoadingIndicator(loadingDiv);
                console.error("âŒ å®Œæ•´é”™è¯¯ä¿¡æ¯ï¼š", error);
                let errorMsg = `AIåŠ©æ‰‹æš‚æ—¶æ— æ³•å“åº”ï¼š${error.message}`;
                if (error.message.includes("CORS") || error.message.includes("è·¨åŸŸ")) {
                    errorMsg += "<br><br>ğŸ’¡ å¯èƒ½åŸå› ï¼šæµè§ˆå™¨è·¨åŸŸé™åˆ¶ï¼Œè¯·ä½¿ç”¨åç«¯ä»£ç†æˆ–å®‰è£…CORSæ’ä»¶ï¼ˆå¦‚Chromeçš„Allow CORSï¼‰";
                } else if (error.message.includes("401") || error.message.includes("Unauthorized")) {
                    errorMsg += "<br><br>ğŸ’¡ å¯èƒ½åŸå› ï¼šAPI Keyæ— æ•ˆ/è¿‡æœŸï¼Œè¯·æ£€æŸ¥å¹¶æ›¿æ¢ä¸ºæœ‰æ•ˆçš„Key";
                } else if (error.message.includes("403")) {
                    errorMsg += "<br><br>ğŸ’¡ å¯èƒ½åŸå› ï¼šAPI Keyæƒé™ä¸è¶³æˆ–è´¦å·æ— ä½™é¢";
                }
                displayMessage(errorMsg, "ai", true);
            }
        }

        // äº‹ä»¶ç›‘å¬
        sendButton.addEventListener("click", sendMessage);
        userQuestionInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        historyList.addEventListener("click", (e) => {
            if (e.target.tagName === "LI" && !e.target.classList.contains("empty")) {
                const index = e.target.dataset.index;
                loadHistoryConversation(index);
            }
        });
        fontToggleBtn.addEventListener("click", toggleFontMode);

        // åˆå§‹åŒ–
        window.onload = () => {
            initFontMode();
            initDailyHealthTip();
            renderHistory();
            console.log("âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆï¼Œå¦‚éœ€æ’æŸ¥é—®é¢˜ï¼Œè¯·å‘é€æ¶ˆæ¯åæŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ï¼");
        };
    </script>
</body>
</html>